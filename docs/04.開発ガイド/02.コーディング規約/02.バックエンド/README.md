# バックエンドのコーディング規約

## 概要

このドキュメントでは、バックエンド開発におけるコーディング規約について説明します。  
コーディング規約は、コードの可読性、保守性、および一貫性を向上させるためのガイドラインです。

- フレームワーク: FastAPI
- 言語: Python
- ORM: SQLAlchemy
- データベース: PostgreSQL
- API ドキュメント: Swagger UI (OpenAPI)
- テスト: pytest
- リンター: flake8, black
- 型ヒント: mypy

## 命名規則

- 変数、関数の命名は、スネークケース（例: `user_name`）を使用する
- クラス名は、パスカルケース（例: `UserProfile`）を使用する
- 定数の命名は、アッパースネークケース（例: `MAX_LENGTH`）を使用する
- モジュール名、パッケージ名は、スネークケース（例: `user_profile`）を使用する
- メソッド名は、スネークケース（例: `get_user`）を使用する

## コードフォーマット

- インデントは、スペース 4 つを使用する
- 行の長さは、88 文字以内に収める（Black のデフォルト設定）
- 関数、クラス、メソッド間は、2 行の空行を開ける
- インポートは、標準ライブラリ、サードパーティライブラリ、ローカルモジュールの順に行う
- インポートは、絶対パスを使用する

## コメント、ドキュメンテーション

- コメントは、英語で記述する
- 複数行のコメントには、`"""`を使用する
- 関数、クラス、メソッドには、docstring を記述する
- docstring は、Google スタイルを使用する
- モジュールの先頭には、モジュールの説明を記述する

## ディレクトリ構造

以下のディレクトリ構造を採用します。

- `app`: メインのアプリケーションコード
  - `api`: API エンドポイントの実装
    - `v1`: API バージョン 1
    - `v2`: API バージョン 2
  - `core`: アプリケーションのコア機能
    - `config`: アプリケーションの設定
    - `exceptions`: カスタム例外の定義
    - `security`: 認証・認可に関する機能
    - `crud`: CRUD 操作の実装
    - `db`: データベース接続の設定
    - `logging`: ログの設定を提供します。
  - `models`: データベースモデルの定義
  - `schemas`: Pydantic を使用したスキーマ定義
  - `services`: ビジネスロジックの実装
  - `utils`: ユーティリティ関数
- `tests`: テストコード
  - `unit`: 単体テスト
  - `integration`: 統合テスト
  - `fixtures`: テストデータの定義

各ディレクトリの責務は以下の通りです。

- `api`: FastAPI のルーターを定義し、エンドポイントの実装を行います。
  - `v1`, `v2`: API のバージョンごとにディレクトリを分けて管理します。
- `core`: アプリケーションの設定、例外処理、セキュリティ関連の機能を提供します。
  - `config`: アプリケーションの設定を管理します。
  - `exceptions`: カスタム例外を定義します。
  - `security`: 認証・認可に関する機能を提供します。
  - `crud`: CRUD 操作の実装を提供します。
  - `db`: データベース接続の設定を提供します。
  - `logging`: ログの設定を提供します。
- `models`: SQLAlchemy を使用してデータベースのモデルを定義します。
- `schemas`: Pydantic を使用して、API のリクエスト・レスポンスのスキーマを定義します。
- `services`: ビジネスロジックを実装し、データベースとのやり取りを抽象化します。
- `utils`: 汎用的なユーティリティ関数を提供します。

## エラーハンドリング

- 例外は、適切な HTTP ステータスコードを使用して処理する
- カスタム例外を定義し、エラーの種類を明確にする
- ログを適切に出力し、エラーの原因を特定しやすくする

## セキュリティ

- ユーザー入力は、常にバリデーションを行う
- SQL インジェクション攻撃を防ぐため、SQL クエリにはパラメータ化されたクエリを使用する
- 重要な情報は、環境変数から取得する

## パフォーマンス

- N+1 問題を避けるため、適切に JOIN を使用する
- キャッシュを適切に活用し、パフォーマンスを向上させる
- 非同期処理を活用し、レスポンスタイムを短縮する

## テスト

- 単体テスト、統合テストを実施する
- テストは、pytest を使用して記述する
- テストデータは、fixture を使用して管理する

## リンター

- flake8 を使用して、コードの品質をチェックする
- black を使用して、コードのフォーマットを統一する
- mypy を使用して、型ヒントの整合性をチェックする

## API ドキュメント

- Swagger UI を使用して、API ドキュメントを自動生成する
- API のエンドポイントには、適切な説明とサンプルを記載する
- レスポンスのスキーマは、Pydantic を使用して定義する

## データベース

- データベースは、PostgreSQL を使用する
- マイグレーションには、Alembic を使用する
- データベースのスキーマは、SQLAlchemy を使用して定義する

## ドキュメント

- コーディング規約やアーキテクチャの決定事項は、Markdown で文書化する
- ドキュメントの構造は、`FastAPI-template`を参考にする
- ドキュメントの作成手順は以下の通りとする
  1. ER 図を作成し、データベース設計を行う
  2. API 設計を行い、エンドポイントとスキーマを定義する
  3. コーディング規約を決定し、Markdown にまとめる
- ドキュメントのテストには、以下のツールを使用するか検討する
  - デッドリンクのチェック: `markdown-link-check`
  - Markdown 構文のチェック: `markdownlint`
  - テキストのチェック: `textlint`
