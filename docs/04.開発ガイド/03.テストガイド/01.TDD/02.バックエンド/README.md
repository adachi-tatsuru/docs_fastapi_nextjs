# バックエンドのテスト駆動開発 (TDD)

## 概要

このドキュメントでは、FastAPI を使用したバックエンド開発におけるテスト駆動開発 (TDD) のプロセスと手法について説明します。  
TDD は、テストを先に書き、そのテストを満たすようにコードを実装する開発手法です。  
これにより、テストカバレッジの向上、コードの品質向上、リファクタリングの容易さなどのメリットが得られます。

## TDD のプロセス

1. テストを書く (Red)
   - 実装する機能の仕様をもとに、テストを先に書きます。
   - このテストは、まだ実装されていない機能に対するものなので、失敗します。
2. テストを通過するコードを書く (Green)
   - テストを通過するために必要な最小限のコードを実装します。
   - この段階では、コードの美しさや効率性は重視しません。
3. コードをリファクタリングする (Refactor)
   - テストが通過した状態で、コードの品質を改善します。
   - 重複の排除、コードの可読性の向上、パフォーマンスの改善などを行います。
4. テストを再実行する
   - リファクタリング後に、すべてのテストが通過することを確認します。
   - テストが失敗した場合は、リファクタリングによって新たなバグが発生していないか確認します。
5. プロセスの繰り返し
   - 次の機能やテストケースに対して、同じプロセスを繰り返します。

## 利用ツール・ライブラリ

- テストランナー: pytest
- Web フレームワーク: FastAPI
- HTTP クライアント: httpx
- モックライブラリ: pytest-mock

## テスト対象

- API エンドポイント
  - リクエストデータの検証
  - レスポンスデータの検証
  - 認証・認可の検証
  - エラーハンドリングの検証
- サービスレイヤー
  - ビジネスロジックの検証
  - データベースとのインタラクションの検証
  - 外部サービスとの連携の検証
- データアクセスレイヤー
  - データベースクエリの検証
  - データの整合性の検証
  - トランザクション処理の検証

## テストの記述方法

- テストファイルの命名規則: `test_*.py`
- テストケースの構造:
  - `def test_*():` 関数を使用してテストケースを定義
  - `assert` 文を使用してアサーションを記述

```python
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_get_user():
    response = client.get("/users/1")
    assert response.status_code == 200
    assert response.json() == {
        "id": 1,
        "name": "John Doe",
        "email": "john@example.com"
    }

def test_create_user():
    response = client.post("/users", json={
        "name": "Jane Doe",
        "email": "jane@example.com"
    })
    assert response.status_code == 201
    assert response.json()["id"] is not None
    assert response.json()["name"] == "Jane Doe"
    assert response.json()["email"] == "jane@example.com"
```

## ベストプラクティス

- 単一の責任を持つ小さなテストを書く
- テストケースを独立して実行できるようにする
- テストデータは明示的に定義する
- モックやスタブを活用して、テストの対象を分離する
- テストの可読性を重視し、わかりやすい命名を心がける
- テストのメンテナンス性を考慮し、DRY 原則に従う
- データベースのセットアップとクリーンアップを適切に行う
